// These are addresses for the pixel buffer and text buffer
.EQU PIX_WIDTH, 320
.EQU PIX_WIDTH_HALF, 160
.EQU PIX_HEIGHT, 240
// Think of PixBuffer as [[u16; 320]; 240], 240 by 320 array of half-words
.EQU TEXT_BUFFER, 0xc9000000
.EQU TEXT_WIDTH, 80
.EQU TEXT_HEIGHT, 60

// These are some useful defines that will help you access structure fields
.EQU PIXMAP_WIDTH, 0
.EQU PIXMAP_HEIGHT, 2
.EQU PIXMAP_TRANSPARENCY, 4
.EQU PIXMAP_PIXELDATA, 6

// controller interface
.EQU PIX_BUFFER_REG, 0xff203020
.EQU PIX_BACKBUFFER_REG, 0xff203024
.EQU PIX_STATUS_REG, 0xff20302c

.global _start
_start:

	// Inital stack
	mov sp, #0x800000

	// some callee-saved registers for the infinite loop
	mov r4, #1
	ldr r5, =PIX_BACKBUFFER_REG
	ldr r6, =PIX_BUFFER_REG
	ldr r7, =PIX_STATUS_REG

	// set up double buffer
	// put 0x00800000 into backbuffer register
	mov r0, #0x00800000
	str r0, [r5]
	// swap registers
	mov r0, #1
	str r0, [r6]
	// wait for vsync to finish
keepWaiting0:
	ldr r0, [r7]
	and r0, r0, #0x1
	cmp r0, #0
	bne keepWaiting0
	// put 0xc8000000 into the backbuffer register
	mov r0, #0xc8000000
	str r0, [r5]

	// track mario's motion
	mov r8, #16 // xpos
	mov r9, #16 // ypos
	mov r10, #7 // xvel
	mov r11, #9 // yvel

inf_loop:

	// ensure vsync is done before writing
keepWaiting1:
	ldr r0, [r7]
	and r0, r0, #0x1
	cmp r0, #0
	bne keepWaiting1

	// move mario a bit
	add r8, r8, r10
	cmp r8, #304
	bge bouncex
	cmp r8, #16
	blt bouncex
	b nobouncex
bouncex:
	rsb r10, r10, #0
nobouncex:
	add r9, r9, r11
	cmp r9, #224
	bge bouncey
	cmp r9, #16
	blt bouncey
	b nobouncey
bouncey:
	rsb r11, r11, #0
nobouncey:

	// clear display
	mov r0, #0
	bl ClearVGA

	// draw some things
	ldr r0, =SimplePix
	mov r1, #0
	mov r2, #0
	bl BitBlit
	ldr r0, =SimplePix
	mov r1, #100
	mov r2, #100
	bl BitBlit
	ldr r0, =mario
	mov r1, r8
	mov r2, r9
	bl BitBlit
	ldr r0, =SimplePix
	mov r1, #130
	mov r2, #130
	bl BitBlit

	// buffer swap
	str r4, [r6]

	b inf_loop

.data

.align 1
message:
	.asciz "I should be cleared when the marios are done"

// You can use this small simple data to test your BitBlit routine
// It should draw a small brown rectangle (transparent in the middle)
.align 1
SimplePix:
	.hword 8, 8, 0xfffe
	.hword 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4
	.hword 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4
	.hword 0xc4c4, 0xc4c4, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xc4c4, 0xc4c4
	.hword 0xc4c4, 0xc4c4, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xc4c4, 0xc4c4
	.hword 0xc4c4, 0xc4c4, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xc4c4, 0xc4c4
	.hword 0xc4c4, 0xc4c4, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xc4c4, 0xc4c4
	.hword 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4
	.hword 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4, 0xc4c4

mario:
	.hword 64, 32, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7de, 0xf7ff, 0xf7ff, 0xf7ff, 0xf7ff, 0xf7ff
	.hword 0xf7ff, 0xf7ff, 0xf7ff, 0xf7de, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef7d, 0xc40f, 0xbb8d
	.hword 0xbb8e, 0xbb8e, 0xbb8e, 0xbb8e, 0xbb8e, 0xbb8e, 0xbb8e, 0xc410, 0xef7d, 0xf7be
	.hword 0xf7be, 0xef7c, 0xd615, 0xd5f4, 0xd5f4, 0xd614, 0xd5f4, 0xde36, 0xef9d, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7de, 0xef5d, 0xa165, 0x9082, 0x98a2, 0x98a2, 0x90a3, 0x90c3, 0x90c3, 0x90c3
	.hword 0x90a2, 0x9986, 0xef5c, 0xf7de, 0xf7de, 0xef3b, 0xc4ee, 0xc4cd, 0xc4cd, 0xc4cd
	.hword 0xc4cd, 0xcd50, 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xef7d, 0xbb4d, 0xaa89, 0x9924, 0x98e3, 0x98e3, 0x98e4
	.hword 0x98e3, 0x98e4, 0x98e4, 0x9904, 0x9904, 0x9924, 0xaa8a, 0xb2aa, 0xaaaa, 0xaa89
	.hword 0xa206, 0xa247, 0xc4ce, 0xc4ee, 0xc4ee, 0xcd50, 0xef9d, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef5c, 0xa186, 0x9082
	.hword 0x90e3, 0x90e3, 0x90e3, 0x90e3, 0x9904, 0x9904, 0x9924, 0x9924, 0x9104, 0x9104
	.hword 0x90e3, 0x90e3, 0x90c3, 0x90e3, 0x98e3, 0x9965, 0xbc8d, 0xc4ce, 0xbcad, 0xcd30
	.hword 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7de, 0xef7d, 0x69c6, 0x50c2, 0x5903, 0x5903, 0x50e3, 0x5924, 0xb40c, 0xbc6d
	.hword 0xbc6d, 0xb40c, 0x4165, 0x4185, 0xb42c, 0xc48e, 0xde38, 0xcd55, 0x9904, 0x9904
	.hword 0x9985, 0x9985, 0x9965, 0xaa89, 0xef7d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xef9d, 0xdefb, 0xd699, 0x6a27, 0x5964, 0x5103, 0x5103
	.hword 0x5964, 0x61c5, 0xbcad, 0xc50e, 0xc50e, 0xb4ad, 0x2965, 0x3185, 0xbcad, 0xcd50
	.hword 0xef7c, 0xde99, 0x9985, 0x9944, 0x98e4, 0x98e3, 0x90c3, 0xa207, 0xef7d, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef7d, 0x6a07, 0x5964
	.hword 0xb46d, 0xbcad, 0x5964, 0x5123, 0xb46d, 0xc4ee, 0xc4ee, 0xc4ee, 0xc4ee, 0xb48d
	.hword 0x2965, 0x3165, 0xbccd, 0xc50e, 0xc50f, 0xc4ee, 0xbcad, 0xb42c, 0x9104, 0x90e3
	.hword 0x90c3, 0xa208, 0xef7d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xef7c, 0x61c6, 0x5102, 0xb48d, 0xc4ce, 0x5964, 0x5123, 0x9baa, 0xac0c
	.hword 0xbccd, 0xc4ee, 0xc4ee, 0xbcad, 0x5247, 0x5247, 0x9beb, 0xa40c, 0xbccd, 0xc4cd
	.hword 0xc4ee, 0xbc6d, 0x9a06, 0x99a5, 0x90e3, 0xa208, 0xef7d, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef7d, 0x61c6, 0x5102, 0xbc8d, 0xc4ce
	.hword 0x5943, 0x48c2, 0x48c2, 0x5103, 0xb46d, 0xc4ee, 0xc4ce, 0xc4ce, 0xcd0e, 0xb48d
	.hword 0x2945, 0x3185, 0xbcad, 0xc4ee, 0xc4ee, 0xc4ee, 0xc50e, 0xb46d, 0x90a2, 0xa1c7
	.hword 0xef7d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef7d
	.hword 0x61c6, 0x48e2, 0x8b29, 0x9369, 0x7a87, 0x7a67, 0x7a67, 0x7aa7, 0xbc8d, 0xc4ce
	.hword 0xc4ce, 0xbcad, 0x8b8a, 0x7b29, 0x2944, 0x2965, 0x834a, 0x836a, 0x836a, 0x8b6a
	.hword 0xab4a, 0xab4a, 0xb32c, 0xbc0f, 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xef7d, 0x59a5, 0x4081, 0x4081, 0x48c2, 0xb48d, 0xc50e
	.hword 0xc4ee, 0xc4ee, 0xbccd, 0xbccd, 0xc4ce, 0xb46d, 0x2124, 0x18c3, 0x1904, 0x1904
	.hword 0x18e3, 0x18e4, 0x1904, 0x2904, 0x88a2, 0xa1c7, 0xf7be, 0xf7ff, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef9d, 0xb554, 0xacd2
	.hword 0xacf2, 0xacf2, 0xbcce, 0xbccd, 0xbccd, 0xbccd, 0xbccd, 0xbcce, 0xbcce, 0xb4ad
	.hword 0x7b4a, 0x7b29, 0x7b29, 0x7b29, 0x7b29, 0x72e9, 0x6124, 0x68e3, 0x88a3, 0xa1c7
	.hword 0xef7d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7de, 0xf7ff, 0xffff, 0xffff, 0xf7de, 0xc530, 0xbccd, 0xc4cd, 0xbccd
	.hword 0xbcce, 0xbcce, 0xbcce, 0xbcce, 0xc4ee, 0xc4ee, 0xc4ed, 0xc4ee, 0xc4ee, 0xbc6d
	.hword 0x9924, 0x90c3, 0x88a2, 0x99c7, 0xef7d, 0xf7de, 0xf7de, 0xf7de, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xef9d, 0xbb4d, 0xaa89, 0xaaaa, 0xaaaa, 0xaaaa, 0xaa8a
	.hword 0xa206, 0x91e7, 0x5a91, 0x5a91, 0x99e7, 0x99e6, 0x99e6, 0x99e6, 0x99e6, 0x91e7
	.hword 0x5291, 0x5a90, 0x99e6, 0x99c5, 0x88c3, 0x9165, 0xd5b6, 0xde38, 0xf7de, 0xce58
	.hword 0x7aca, 0x93ce, 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef9d, 0xef9d, 0xf79d, 0xef5c, 0xa1a6, 0x8861
	.hword 0x9082, 0x9082, 0x9082, 0x8882, 0x90a2, 0x80c4, 0x31b2, 0x31b2, 0x88c4, 0x88a3
	.hword 0x88a3, 0x88a3, 0x88a2, 0x80c4, 0x31b2, 0x31b1, 0x80c4, 0x88c3, 0x88c3, 0x99e7
	.hword 0xef9d, 0xf7de, 0xf7bd, 0xb575, 0x4061, 0x61e6, 0xef9d, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef9d, 0xcdb2, 0xc52f
	.hword 0xc530, 0xc50f, 0x9965, 0x90a2, 0x90c3, 0x90c3, 0x90c3, 0x90c3, 0x90c3, 0x90c3
	.hword 0x80e5, 0x7906, 0x41af, 0x41af, 0x88c4, 0x90c2, 0x90c3, 0x88c3, 0x80e5, 0x7907
	.hword 0x396f, 0x5251, 0xde79, 0xe6da, 0xfffe, 0xce37, 0x61e6, 0x5985, 0x40c2, 0x6a27
	.hword 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xef9d, 0xc530, 0xbcad, 0xbcad, 0xbc8d, 0x99a5, 0x9104, 0x90e3, 0x90c3
	.hword 0x90c3, 0x90c3, 0x90c3, 0x90c3, 0x90c2, 0x88c4, 0x31d2, 0x31d2, 0x78e6, 0x80e4
	.hword 0x80e4, 0x80e4, 0x88e4, 0x7905, 0x3a10, 0x4ad3, 0xd6bc, 0xd6fd, 0xdefd, 0xad35
	.hword 0x40a2, 0x48c2, 0x40c2, 0x6a27, 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef9d, 0xc530, 0xbc8d, 0xbcad, 0xbcad
	.hword 0xb46c, 0xb42c, 0x9103, 0x8882, 0x90a2, 0x90c2, 0x90c2, 0x90c2, 0x90c2, 0x88c4
	.hword 0x31b1, 0x29d3, 0x31b2, 0x31b2, 0x31b1, 0x31b1, 0x31b1, 0x4230, 0xad24, 0xa4e5
	.hword 0x3a32, 0x31f3, 0x3213, 0x31d0, 0x48e3, 0x48e2, 0x40c2, 0x6a27, 0xef9d, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef9d
	.hword 0xd5d4, 0xc571, 0xbcce, 0xb48d, 0xc530, 0xc551, 0xaaeb, 0xa269, 0x7927, 0x7107
	.hword 0x7106, 0x7906, 0x78e6, 0x7107, 0x31b1, 0x31f2, 0x4aaf, 0x4aaf, 0x31f2, 0x29d2
	.hword 0x29d3, 0x3a31, 0x9467, 0x8c28, 0x31d1, 0x29b2, 0x29d2, 0x31b0, 0x48e3, 0x48e2
	.hword 0x40a2, 0x6a27, 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf79d, 0xbd0f, 0xac4b, 0xde98, 0xffff
	.hword 0xffff, 0xf7df, 0x4ab4, 0x29b2, 0x29d3, 0x29d2, 0x29d2, 0x29d2, 0x29d2, 0x3a11
	.hword 0xb544, 0xb543, 0x3a31, 0x29b2, 0x29d2, 0x29d2, 0x29b2, 0x29d2, 0x29d2, 0x29d2
	.hword 0x29d2, 0x31b0, 0x40e3, 0x40e2, 0x40a2, 0x6227, 0xef9d, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef9d
	.hword 0xd615, 0xc572, 0xa470, 0xa491, 0xa4b1, 0x9c91, 0x3a32, 0x29d2, 0x29d2, 0x29d2
	.hword 0x29d2, 0x29d2, 0x29d2, 0x31f2, 0x7bca, 0x7bc9, 0x31f1, 0x29b2, 0x29d2, 0x29d2
	.hword 0x29b2, 0x29b2, 0x29d2, 0x29d2, 0x29d2, 0x31b0, 0x40e3, 0x40c2, 0x40a2, 0x6227
	.hword 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7ff, 0xf7df, 0x61e6, 0x4060, 0x40a1, 0x40a2
	.hword 0x31b0, 0x29d3, 0x29d2, 0x29d2, 0x29d2, 0x29d2, 0x29d2, 0x29d2, 0x29b2, 0x29b2
	.hword 0x29d2, 0x29b2, 0x2191, 0x2191, 0x2171, 0x2171, 0x2191, 0x2191, 0x2191, 0x294f
	.hword 0x4082, 0x4081, 0x3860, 0x61e6, 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef9d, 0x9c2f, 0x7b2b
	.hword 0x5144, 0x48c2, 0x48e2, 0x48e3, 0x31b0, 0x29d3, 0x29d2, 0x29d2, 0x29d2, 0x29d2
	.hword 0x29d2, 0x29b2, 0x29b2, 0x29b2, 0x29b2, 0x3a12, 0x94d8, 0x9d18, 0x9d18, 0x9d18
	.hword 0x9d18, 0x9d18, 0x9d18, 0x9d17, 0xa4b2, 0xa4b1, 0xa4b1, 0xb554, 0xef9d, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xef9d, 0x61e6, 0x3861, 0x40c2, 0x48e2, 0x40c2, 0x40c2, 0x2990, 0x29b2
	.hword 0x29b2, 0x29b2, 0x29b2, 0x29b1, 0x29b1, 0x29b1, 0x29b1, 0x29b1, 0x2191, 0x4253
	.hword 0xef9d, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xfffe, 0xf7ff, 0xf7ff
	.hword 0xf7ff, 0xf7de, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef9d, 0x6207, 0x40a1, 0x40c2, 0x40c2
	.hword 0xa4b2, 0xce17, 0xbe1a, 0xbe1b, 0xbe1a, 0xbe1a, 0xbe1a, 0xbe1a, 0xbe1a, 0xbe1a
	.hword 0xbe1a, 0xbe1a, 0xbe1a, 0xc65b, 0xef9d, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xef9d
	.hword 0x6a48, 0x4903, 0x4924, 0x4924, 0xce58, 0xffff, 0xf7de, 0xf7de, 0xf7de, 0xf7de
	.hword 0xf7de, 0xf7de, 0xf7de, 0xf7de, 0xf7de, 0xf7de, 0xf7de, 0xf7de, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xdefa, 0xdeba, 0xdeba, 0xdeba, 0xef7d, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7de
	.hword 0xf7de, 0xf7de, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be
	.hword 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be, 0xf7be

.text
// Write your ClearTextBuffer, ClearVGA, and BitBlit routines below!

.align 2

/*
ClearTextBuffer

Parameters: none
Returns: none

Pseudocode:
ClearTextBuffer() {
	for (int row = 0; row < 60; ++row) {
		char *buffer = TEXTBUFFER + row << 7;
		for (int col = 0; col < 80; col += 4) {
			MemWord[buffer + col] = {0x20, 0x20, 0x20, 0x20};
		}
	}
}
*/
ClearTextBuffer:
	ldr r3, =0x20202020
	mov r0, #0
	b ClearTextBuffer_outerForCondition
ClearTextBuffer_outerForBody:
	mov r1, #TEXT_BUFFER
	add r1, r1, r0, lsl #7
	mov r2, #0
	b ClearTextBuffer_innerForCondition
ClearTextBuffer_innerForBody:
	str r3, [r1, r2]
	add r2, r2, #4
ClearTextBuffer_innerForCondition:
	cmp r2, #TEXT_WIDTH
	blo ClearTextBuffer_innerForBody
	add r0, r0, #1
ClearTextBuffer_outerForCondition:
	cmp r0, #TEXT_HEIGHT
	blo ClearTextBuffer_outerForBody
	bx lr
// end ClearTextBuffer

/*
ClearVGA

Fills the video buffer with the specified color

Parameters:
	color: u16 // unsigned 16-bit number
Returns: none

Pseudocode:
let colorpair: u32 = (color << 16) | color;
for row in 0..240 {
	let buffer: *u16 = PIX_BUFFER[row];
	for col in 0..(320 / 2) { // col doesn't count pixels, but pixel *pairs*
		MemWord[buffer + col << 2] = colorpair;
	}
}
*/
ClearVGA:
	// r0 = colorpair
	orr r0, r0, r0, lsl #16

	// r1 = buffer (see outer loop's iteration expression)
	ldr r1, =PIX_BACKBUFFER_REG
	ldr r1, [r1]

	// r2 = row
	mov r2, #0
	b ClearVGA_outerForCondition
ClearVGA_outerForBody:

	// r3 = col
	mov r3, #0
	b ClearVGA_innerForCondition
ClearVGA_innerForBody:

	str r0, [r1, r3, lsl #2]

	add r3, r3, #1
ClearVGA_innerForCondition:
	cmp r3, #PIX_WIDTH_HALF
	blo ClearVGA_innerForBody

	add r2, r2, #1
	add r1, r1, #0x400 // update pointer to new row (0x400 is 1 << 10)
ClearVGA_outerForCondition:
	cmp r2, #PIX_HEIGHT
	blo ClearVGA_outerForBody
// end ClearVGA

/*
BitBlit(p: *Pixmap, x: i32, y: i32)

Draws the specified Pixmap into the VGA buffer, centered at the specified x and y coordinates. If
If the image goes past the VGA screen boundaries, pixels are not drawn.

Pseudocode:
BitBlit(p: *Pixmap, x: i32, y: i32) {
	// convert center coordinates to top left corner coordinates
	let y = y - p.height >> 1;
	let x = x - p.width >> 1;

	// find the portion of the pixmap to draw
	let start_row = max(0, -y);
	let start_col = max(0, -x);
	let end_row = min(p.height, PIX_HEIGHT - y);
	let end_col = min(p.width, PIX_WIDTH - x);

	for row in start_row..end_row {
		let buffer: *u16 = PIX_BUFFER[y + row] + x + start_col;
		for col in start_col..end_col {
			let pixel = p.pixeldata[row * p.width + col];
			if pixel != p.transparency {
				buffer[col] = pixel;
			}
		}
	}
}
*/
BitBlit:
	push {r4-r9, lr}

	// r0 = p
	// r1 = x
	// r2 = y

	// r3 = p.width
	ldrh r3, [r0, #PIXMAP_WIDTH]

	// r4 = p.height
	ldrh r4, [r0, #PIXMAP_HEIGHT]

	// r1 = x
	sub r1, r1, r3, lsr #1

	// r2 = y
	sub r2, r2, r4, lsr #1

	// r6 = start_row
	rsb r6, r2, #0
	cmp r6, #0
	bgt BitBlit_0
	mov r6, #0
BitBlit_0:

	// r5 = start_col
	rsb r5, r1, #0
	cmp r5, #0
	bgt BitBlit_1
	mov r5, #0
BitBlit_1:

	// r8 = end_row
	rsb r8, r2, #PIX_HEIGHT
	cmp r8, r4
	blt BitBlit_2
	mov r8, r4
BitBlit_2:

	// r7 = end_col
	rsb r7, r1, #PIX_WIDTH
	cmp r7, r3
	blt BitBlit_3
	mov r7, r3
BitBlit_3:

	// From here on, horizontal coordinates are double what they are in the pseudocode, for ease of
	// fetching the halfword values.
	lsl r1, r1, #1
	lsl r3, r3, #1
	lsl r7, r7, #1
	// skip doubling r5 because it gets reset anyway

	// r4 = PIX_BUFFER[y + start_row] + x
	ldr r4, =PIX_BACKBUFFER_REG
	ldr r4, [r4]
	add r4, r4, r6, lsl #10
	add r4, r4, r2, lsl #10
	add r4, r4, r1

	// r1 = p.transparency
	ldrh r1, [r0, #PIXMAP_TRANSPARENCY]

	// r0 = p.pixeldata
	add r0, #PIXMAP_PIXELDATA

	// r2 = start_col
	lsl r2, r5, #1

	// r6 = row
	// r5 = col

	// outer for loop
	b BitBlit_outerCond
BitBlit_outerBody:

	// r4 = buffer (see loop's iteration expression)

	// inner for loop
	mov r5, r2
	b BitBlit_innerCond
BitBlit_innerBody:

	// r9 = pixel
	mla r9, r6, r3, r5
	ldrh r9, [r0, r9]

	// maybe draw pixel
	cmp r9, r1
	beq BitBlit_skipDraw
	strh r9, [r4, r5]
BitBlit_skipDraw:

	add r5, r5, #2
BitBlit_innerCond:
	cmp r5, r7
	blt BitBlit_innerBody

	add r4, r4, #0x400 // update pointer to new row (0x400 is 1 << 10)
	add r6, r6, #1
BitBlit_outerCond:
	cmp r6, r8
	blt BitBlit_outerBody

	pop {r4-r9, pc}
// end BitBlit

/*
DrawStr

from assignment 2
*/
DrawStr:
	// r1: destRow
	lsl r1, r1, #7
	add r1, r1, #TEXT_BUFFER

	// r3: *str
	b DrawStr_cond
	DrawStr_loop:
	strb r3, [r1, r0]
	add r0, r0, #1
	add r2, r2, #1

	DrawStr_cond:
	cmp r0, #TEXT_WIDTH
	bhs DrawStr_end
	ldrb r3, [r2]
	cmp r3, #0
	bne DrawStr_loop

	DrawStr_end:
	bx lr
// end DrawStr
